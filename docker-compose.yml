version: '3.8'

services:
  # ==========================================
  # 1. Infrastructure: SQL Server
  # ==========================================
  sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: flower_sql_server
    environment:
      - ACCEPT_EULA=Y
      - SA_PASSWORD=MyComplexP@ssw0rd2025
    ports:
      - "1433:1433"
    volumes:
      - sql_data:/var/opt/mssql
    networks:
      - flower_network

  # ==========================================
  # 2. Infrastructure: RabbitMQ
  # ==========================================
  rabbitmq:
    image: rabbitmq:3-management
    container_name: flower_rabbitmq
    ports:
      - "5672:5672"   # AMQP
      - "15672:15672" # Management UI
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    networks:
      - flower_network

  # ==========================================
  # 3. Infrastructure: Redis
  # ==========================================
  redis:
    image: redis:alpine
    container_name: flower_redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - flower_network

  # ==========================================
  # 4. Infrastructure: MongoDB (For Audit Service)
  # ==========================================
  mongo:
    image: mongo:latest
    container_name: flower_mongo
    ports:
      - "27017:27017"
    volumes:
      - mongo_data:/data/db
    networks:
      - flower_network

  # ==========================================
  # 5. Service: Catalog Service
  # ==========================================
  catalogservice:
    image: ${DOCKER_REGISTRY-}catalogservice
    build:
      context: .
      dockerfile: "Catalog Service/Dockerfile"
    ports:
      - "8082:8080"
      - "8083:8081"
    environment:
      - ConnectionStrings__DefaultConnection=Server=sqlserver;Database=CatalogDB;User Id=sa;Password=MyComplexP@ssw0rd2025;TrustServerCertificate=True;
      - RabbitMq__Host=rabbitmq
      - Redis__Url=redis:6379
    depends_on:
      - sqlserver
      - rabbitmq
      - redis
    networks:
      - flower_network

  # ==========================================
  # 6. Service: Auth (Identity) Service
  # ==========================================
  authservice:
    image: ${DOCKER_REGISTRY-}authservice
    build:
      context: .
      dockerfile: "Auth Service/Dockerfile"
    ports:
      - "8090:8080"
      - "8091:8081"
    environment:
      - ConnectionStrings__DefaultConnection=Server=sqlserver;Database=IdentityDB;User Id=sa;Password=MyComplexP@ssw0rd2025;TrustServerCertificate=True;
      - RabbitMq__Host=rabbitmq
    depends_on:
      - sqlserver
      - rabbitmq
    networks:
      - flower_network

  # ==========================================
  # 7. Service: Cart Service
  # ==========================================
  cartservice:
    image: ${DOCKER_REGISTRY-}cartservice
    build:
      context: .
      dockerfile: "Cart Service/Dockerfile"
    ports:
      - "8092:8080"
      - "8093:8081"
    environment:
      - ConnectionStrings__DefaultConnection=Server=sqlserver;Database=CartDB;User Id=sa;Password=MyComplexP@ssw0rd2025;TrustServerCertificate=True;
      - RabbitMq__Host=rabbitmq
      - Redis__Url=redis:6379
    depends_on:
      - sqlserver
      - rabbitmq
      - redis
    networks:
      - flower_network

  # ==========================================
  # 8. Service: Ordering Service
  # ==========================================
  orderingservice:
    image: ${DOCKER_REGISTRY-}orderingservice
    build:
      context: .
      dockerfile: "Ordering Service/Dockerfile"
    ports:
      - "8094:8080"
      - "8095:8081"
    environment:
      - ConnectionStrings__DefaultConnection=Server=sqlserver;Database=OrderingDB;User Id=sa;Password=MyComplexP@ssw0rd2025;TrustServerCertificate=True;
      - RabbitMq__Host=rabbitmq
    depends_on:
      - sqlserver
      - rabbitmq
    networks:
      - flower_network

  # ==========================================
  # 10. Service: Payment Service
  # ==========================================
  paymentservice:
    image: ${DOCKER_REGISTRY-}paymentservice
    build:
      context: .
      dockerfile: "Payment Service/Dockerfile"
    ports:
      - "8098:8080"
      - "8099:8081"
    environment:
      - ConnectionStrings__DefaultConnection=Server=sqlserver;Database=PaymentDB;User Id=sa;Password=MyComplexP@ssw0rd2025;TrustServerCertificate=True;
      - RabbitMq__Host=rabbitmq
    depends_on:
      - sqlserver
      - rabbitmq
    networks:
      - flower_network

  # ==========================================
  # 11. Service: Notification Service
  # ==========================================
  notificationservice:
    image: ${DOCKER_REGISTRY-}notificationservice
    build:
      context: .
      dockerfile: "Notification Service/Dockerfile"
    ports:
      - "8100:8080"
      - "8101:8081"
    environment:
      - RabbitMq__Host=rabbitmq
    depends_on:
      - rabbitmq
    networks:
      - flower_network

  # ==========================================
  # 12. Service: Audit Service
  # ==========================================
  auditservice:
    image: ${DOCKER_REGISTRY-}auditservice
    build:
      context: .
      dockerfile: "Audit Service/Dockerfile"
    ports:
      - "8102:8080"
      - "8103:8081"
    environment:
      - ConnectionStrings__MongoDb=mongodb://mongo:27017
      - RabbitMq__Host=rabbitmq
    depends_on:
      - mongo
      - rabbitmq
    networks:
      - flower_network

  # ==========================================
  # 13. API Gateway
  # ==========================================
  apigateway:
    image: ${DOCKER_REGISTRY-}apigateway
    build:
      context: .
      dockerfile: "API Gateway/Dockerfile"
    ports:
      - "8888:8080"
      - "8889:8081"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
    depends_on:
      - authservice
      - catalogservice
      - cartservice
      - orderingservice
    networks:
      - flower_network

volumes:
  sql_data:
  rabbitmq_data:
  redis_data:
  mongo_data:

networks:
  flower_network:
    driver: bridge